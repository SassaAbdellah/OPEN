<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:f="http://java.sun.com/jsf/core" >

    <body>

        <ui:composition template="/templates/simpleLayout.xhtml">




            <ui:define name="windowTitle">
                #{msgs.geocodeSearchTitle}
            </ui:define>

            <ui:define name="content">



          


                <!-- initialize Result Point and Webflow  -->
                #{point.smartUpdate()}
                #{webflow.smartUpdate()}

                <form action="#{point.targetURL}" method="GET" >


                    <div class="formLabel"> Address
                    </div>
                    <div class="formInput">
                        <h:inputTextarea id="#{point.paramAddress}"  value="#{point.address}" /> 
                    </div>     


                    <div class="formInput">
                        <h:inputHidden id="#{point.paramTarget}"    value="#{point.target}" />
                    </div> 

                    <table>
                    
                     <tr>
                         <td>   <span class="formLabel">  #{msgs.geolocationLongitude}   </span> </td>
                         <td> : </td>
                         <td>   <span id="lonSpan"> #{point.lon} </span> <h:inputHidden  id="#{point.paramLon}" value="#{point.lon}" /> </td>
                 
                     </tr>
                        
                        <tr>
                          <td>  <span class="formLabel">   #{msgs.geolocationLatitude} </span> </td> 
                          <td>: </td>
                          <td> <span id="latSpan"> #{point.lat} </span>   <h:inputHidden id="#{point.paramLat}"   value="#{point.lat}" /> </td>
                        </tr>
                    </table>   


                    <button type="submit" >  #{msgs.formAccept} </button>

                </form>     

                <!-- **************************************************************************** -->
                <!-- div to show the map  --> 

                <!-- **************************************************************************** -->

                <div id="mapdiv" style="width:300px; height:300px;" > </div>



                <!-- include standard jquery  -->

                <h:outputScript library="js" name="jquery-1.4.1.js" />
                
                <!-- we may deliver a local OpenLayers version 2.12              -->
                <!-- alternatively, it can be included from OpenLayers.org   -->
                <!-- h:outputScript library="js" name="OpenLayers.js" /      -->
               
                <script src="http://www.openlayers.org/api/OpenLayers.js"></script>
               
                
                
                
                <!--  TODO: externalize the Javascript code below, -->
                <!--  into external javascript.js library          -->
                <!--  so that the xhtml is not cluttered anymore   -->
                
                
               <script>
                   
                    //	/////////////////////////////////////////////////////////////
                    // create openlayers control object
                    // //////////////////////////////////////////////////////////////
    
                    OpenLayers.Control.Click = OpenLayers.Class(OpenLayers.Control, {
                        defaultHandlerOptions: {
                            'single': true, // enable zoom on single click
                            'double': true, // enable moving the marker on dblclick
                            'pixelTolerance': 0,
                            'stopSingle': false,
                            'stopDouble': false
                        },

                        initialize: function(options) {
                            this.handlerOptions = OpenLayers.Util.extend(
                            {}, this.defaultHandlerOptions
                        );
                            OpenLayers.Control.prototype.initialize.apply(
                            this, arguments
                        );
                            this.handler = new OpenLayers.Handler.Click(
                            this, {
                                // react to double mouse click only,
                                // ignore single mouseclic
                                'dblclick': this.moveMarker
                            }, this.handlerOptions
                        );
                        },
                
                        // move the marker to doubleclicked coordinates
                        moveMarker: function(e) {
                            var coord = map.getLonLatFromViewPortPx(e.xy);

                            // ///////////////////////////////////	
                            //  move the marker to current click position 
                            // ///////////////////////////////////
                            jorideMarkersLayer.clearMarkers();    
                            var nextMarker=new OpenLayers.Marker(coord); 
                            jorideMarkersLayer.addMarker(nextMarker);
             
                  
                            // /////////////////////////////////////////////////
                            // transform display friendly EPSG:90913 coordinate 
                            // back to latitude/Longitude EPSG:4236 
                            // /////////////////////////////////////////////////

                            var lonlat=coord.transform(
                            new OpenLayers.Projection("EPSG:900913"), 
                            new OpenLayers.Projection("EPSG:4326")
                        );

                            // set longitude and latitude in input controls	
                            // (i.e: input controls that have class lat or lon) 
                            $('#lat').val(lonlat.lat); 
                            $('#lon').val(lonlat.lon); 
                            
                            

                            $('#latSpan').html(lonlat.lat)
                            $('#lonSpan').html(lonlat.lon); 
                            
                         
                   
                            // no more actions on doubleclick (i.e: do not zoom in)
                            this.handler.stopDouble = true;
                        }

                    });

           
                    //	/////////////////////////////////////////////////////////////
                    // create openlayers control object
                    // //////////////////////////////////////////////////////////////
    
    





                    map = new OpenLayers.Map("mapdiv");
                    map.addLayer(new OpenLayers.Layer.OSM());

                    var lonLat = new OpenLayers.LonLat(#{point.lon},#{point.lat}).transform(
                    new OpenLayers.Projection("EPSG:4326"), // transform from WGS 1984 to Spherical Mercator Projection
                    map.getProjectionObject() //
                );
                    
                    
                </script>
                <!-- creation of map and control object ends above -->    
                <!-- code above has to be externalized first       -->
                
                
                
                
                <!-- below, we start feeding the map with data -->
                
                <script>
                    
                    
                    

                    var zoom=16;

    		
                    // add markers layer. Overwrite calculate in Range function to 
                    // ensure that markers are visible at any zoom level
       
                    var jorideMarkersLayer= new OpenLayers.Layer.Markers("markers", {'calculateInRange': function() { return true; }});           
                    map.addLayer(jorideMarkersLayer);
                
                    var marker=new OpenLayers.Marker(lonLat);
                    jorideMarkersLayer.addMarker(marker);
                    map.setCenter (lonLat, zoom );

                    // //////////////////////////////////////////
                    // add click handler control 
                    // //////////////////////////////////////////
		
                    var click = new OpenLayers.Control.Click();
                    map.addControl(click);
                    click.activate();



                </script>










            </ui:define>

        </ui:composition>



    </body>
</html>
